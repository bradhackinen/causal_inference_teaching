---
title: "Pizzeria Demo: Simulating Causal Relationships in R"
author: "Brad Hackinen"
date: "Fall 2025"
output:
  html_document:
    df_print: kable
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
```


# Introduction

This markdown file is intended to demonstrate how we can use R to simulate simple scenarios and build intuition about causal relationships in data. Later in the course we will use R to *estimate* the magnitude of causal effects, and simulations are also very useful for exploring how well a given estimation procedure works in different scenarios.

For now, we are simply going to replicate the Pizzeria marketing activity we did with slips of paper in our first session. 

Recall the basic setup:

- We are considering of different ways of distributing flyers to students on campus.
- The treatment is receiving a flyer
- The outcome is the number of pieces of pizza purchased.
- Some people are "in line" and others are not. We will call anyone with $Y_i(0)>0$ "in line".
- We want to know whether a each marketing strategy is "worth it", in terms of return on investment (ROI)


# Generating Potential Outcomes

First, let's set up some data with potential outcomes for the number of slices of pizza people will eat. When in R, I will use simplified notation that is more compatible with R syntax:

- `Y0` for $Y_i(0)$
- `Y1` for $Y_i(1)$

In class, these variables were represented as numbers on slips of paper. In R, we are going to represent these variables in a table. In the tidyverse, a basic data table object is called a "tibble". We can create a tibble of individuals $i=1,2,3,...N$ with random potential outcomes like so:

```{r}
N = 1000

potential_outcomes <- tibble(
  i = 1:N,
  Y0 = sample(c(0,0,0,0,1,2,3),N,replace=TRUE),
  Y1 = sample(0:3,N,replace=TRUE)
)
```

We can use the `head` function to print out the first few rows of data so that we can see what we created:

```{r}
head(potential_outcomes,5)
```

We can add or modify variables in a tibble with the `mutate` function.

Here we use `mutate` a new column called `delta` that is equal to Y1 - Y0: (Do you remember what this quantity this called?)
```{r}
potential_outcomes <- mutate(potential_outcomes,delta = Y1 - Y0)

head(potential_outcomes,5)
```

One of the nice things about R is that it is very easy to make certain plots that summarize your data.

Let's plot the distribution of `delta` as a simple histogram:

```{r}
ggplot(potential_outcomes,aes(delta)) +
  geom_histogram(binwidth=0.5)
```


# Simulating a Bad Marketing Strategy

How many pizzas do we sell, and what is the cost of flyers if we give flyers to those who are "in line"?

We are assuming that anyone with Y0 > 0 is "in line". So we want to create a new treatment variable D such that:

 - D=1 if Y0 > 0
 - D=0 otherwise

```{r}
simulation_data <- mutate(potential_outcomes,
                          D = ifelse(Y0>0,1,0))

head(simulation_data,5)
```
Now we can compute the *observed outcome* Y that each unit obtains (i.e., how many pieces of pizza each person buys). We just need to select:

- Y=Y0 for units where D=0
- Y=Y1 for units where D=1

```{r}
simulation_data <- mutate(simulation_data,
                          Y = ifelse(D==1,Y1,Y0))

head(simulation_data,5)
```

Finally, we can compute the total number of pizzas and the same "Naive ROI" and "True ROI" we computed in class. The `summarize` function allows us to use operations like `sum` and apply them to all the values in a column:

```{r}
summarize(simulation_data,
    pizzas = sum(Y),
    flyers = sum(D),
    pizzas_with_flyer = sum(D*Y),
    total_effect = sum(Y) - sum(Y0),
    naive_ROI = (pizzas_with_flyer - flyers)/flyers,
    true_ROI = (total_effect - flyers)/flyers
)
```

One thing that is useful about running the simulation in R instead of with bits of paper is that we can quickly run the simulation again with different randomly generated potential outcomes. Try using the "Run All" command to execute all the chunks in order. What do you see?


# Exercise

What would a *good* marketing strategy look like in this setting? How would you write code to simulate it, and what would the outcomes be?

Here is a rough outline. See if you can fill in the details:

**Step 1: Generate Potential Outcomes**

(Hint: you can re-use some code from above)

```{r}
N = 1000

potential_outcomes <- tibble(
  i = 1:N,
  Y0 = sample(c(0,0,0,0,1,2,3),N,replace=TRUE),
  Y1 = sample(0:3,N,replace=TRUE)
)
```

**Step 2: Assign treatment**

(Hint: Who should be treated to maximize your true ROI? How can you modify some code from above to implement your strategy?)

```{r}

# Treating only people who will change from 0 to 3 pizzas gives us the maximum possible benefit per flyer (in this simulation)
simulation_data <- mutate(potential_outcomes,D = ifelse(Y1 - Y0 >= 3,1,0))

head(simulation_data,5)
```

**Step 3: Assign Observed Outcomes**

(Hint: You can re-use some code from above)

```{r}
simulation_data <- mutate(simulation_data,Y = ifelse(D==1,Y1,Y0))
```

**Step 4: Summarize the Outcomes**

(Hint: You can re-use some code from above)

```{r}
summarize(simulation_data,
    pizzas = sum(Y),
    flyers = sum(D),
    pizzas_with_flyer = sum(D*Y),
    total_effect = sum(Y) - sum(Y0),
    naive_ROI = (pizzas_with_flyer - flyers)/flyers,
    true_ROI = (total_effect - flyers)/flyers
)
```

**Step 5: Reflect**

- How do the naive and true ROI generated by your marketing strategy compare to the ones from the "bad" marketing strategy?
- Could you implement your preferred strategy in real life? What challenges might you face?



**Bonus Exercise**

If that was too easy, here is something to challenge you:

  1. Simulate all the marketing strategies we have discussed in class (flyers for all, flyers for those in line, flyers for those not in line, and your optimal strategy).
  2. Create a single figure that presents both the naive and true ROI for each strategy. Make the plot as clear and well labeled as possible - aim for something that could be published in a consulting report.